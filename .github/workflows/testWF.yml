name: Testing pipeline

on:
  workflow_dispatch:

jobs:
  install_symphony:
    name: Symphony Install
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Clone Symphony repository
        run: |
          git clone https://github.com/eclipse-symphony/symphony.git $HOME/symphony
          echo "Symphony repository cloned successfully"
          
          # List directory structure to understand the layout
          echo "=== Symphony repository structure ==="
          find $HOME/symphony -type d -name "*rust*" || echo "No rust directories found"
          find $HOME/symphony -type d -name "*provider*" || echo "No provider directories found"
          ls -la $HOME/symphony/api/ || echo "API directory not found"

      - name: Check for Rust components
        run: |
          echo "Checking for Rust components in Symphony..."
          
          # Check various possible locations for Rust code
          RUST_DIRS=(
            "$HOME/symphony/api/pkg/apis/v1alpha1/providers/target/rust"
            "$HOME/symphony/providers/rust"
            "$HOME/symphony/rust"
            "$HOME/symphony/api/providers/rust"
          )
          
          RUST_FOUND=false
          for dir in "${RUST_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "Found Rust directory: $dir"
              RUST_FOUND=true
              echo "RUST_DIR=$dir" >> $GITHUB_ENV
              break
            fi
          done
          
          if [ "$RUST_FOUND" = false ]; then
            echo "No Rust provider directory found. Skipping Rust build."
            echo "RUST_DIR=" >> $GITHUB_ENV
          fi

      - name: Build native Rust library (if exists)
        run: |
          if [ -n "$RUST_DIR" ] && [ -d "$RUST_DIR" ]; then
            echo "Building Rust library in $RUST_DIR"
            cd "$RUST_DIR"
            
            # Check if Cargo.toml exists
            if [ -f "Cargo.toml" ]; then
              cargo build --release
              echo "Rust library built successfully"
              
              # Set the library path for subsequent steps
              if [ -f "target/release/libsymphony_provider.so" ]; then
                echo "RUST_LIB_PATH=$RUST_DIR/target/release" >> $GITHUB_ENV
              elif [ -f "target/release/libsymphony_provider.dylib" ]; then
                echo "RUST_LIB_PATH=$RUST_DIR/target/release" >> $GITHUB_ENV
              else
                echo "Built library not found in expected location"
                ls -la target/release/ || echo "Release directory not found"
              fi
            else
              echo "No Cargo.toml found in $RUST_DIR"
            fi
          else
            echo "No Rust directory found, skipping Rust build"
            echo "RUST_LIB_PATH=" >> $GITHUB_ENV
          fi

      - name: Build symphony-api Go binary
        run: |
          cd $HOME/symphony/api
          
          # Set library path if Rust library was built
          if [ -n "$RUST_LIB_PATH" ]; then
            export LD_LIBRARY_PATH="$RUST_LIB_PATH:$LD_LIBRARY_PATH"
            echo "Using Rust library path: $RUST_LIB_PATH"
          fi
          
          # Initialize Go modules if needed
          if [ ! -f go.mod ]; then
            go mod init symphony-api
            echo "Initialized Go modules"
          fi
          
          # Download and tidy dependencies
          go mod tidy
          
          # Build the binary
          go build -o symphony-api
          echo "Symphony API binary built successfully"

      - name: Create configuration file
        run: |
          cd $HOME/symphony/api
          
          # Create basic configuration if it doesn't exist
          if [ ! -f symphony-api-no-k8s.json ]; then
            cat > symphony-api-no-k8s.json << 'EOF'
{
  "port": "8082",
  "logLevel": "Debug",
  "providers": []
}
EOF
            echo "Configuration file created"
          else
            echo "Configuration file already exists"
          fi

      - name: Test symphony-api
        run: |
          cd $HOME/symphony/api
          
          # Set library path if Rust library was built
          if [ -n "$RUST_LIB_PATH" ]; then
            export LD_LIBRARY_PATH="$RUST_LIB_PATH:$LD_LIBRARY_PATH"
          fi
          
          # Kill any existing processes
          pkill -f symphony-api || true
          
          # Test run the API with timeout
          echo "Testing Symphony API..."
          timeout 30s env SYMPHONY_API_URL="http://localhost:8082/v1alpha2/" \
            USE_SERVICE_ACCOUNT_TOKENS="false" \
            ./symphony-api -c ./symphony-api-no-k8s.json -l Debug &
          
          API_PID=$!
          echo "Started Symphony API with PID: $API_PID"
          
          # Wait for API to start
          sleep 10
          
          # Test connectivity
          echo "Testing API connectivity..."
          curl -f http://localhost:8082/health 2>/dev/null || \
          curl -f http://localhost:8082/ 2>/dev/null || \
          echo "API connectivity test failed or endpoint not available"
          
          # Stop the API
          kill $API_PID 2>/dev/null || pkill -f symphony-api || true
          echo "Symphony API test completed"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: symphony-build
          path: |
            /home/runner/symphony/api/symphony-api
            /home/runner/symphony/api/symphony-api-no-k8s.json
            /home/runner/symphony/api/*.log
          retention-days: 3
