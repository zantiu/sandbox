name: Install and Build Symphony API

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Install Go
        run: |
          sudo apt update -y
          sudo apt install golang-go -y
          go version

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Clone Symphony repository
        run: |
          git clone https://github.com/eclipse-symphony/symphony.git
          ls symphony

      - name: Build native Rust library
        working-directory: symphony/api/pkg/apis/v1alpha1/providers/target/rust
        run: |
          source $HOME/.cargo/env
          cargo build --release

      - name: Build symphony-api Go binary
        working-directory: symphony/api
        run: |
          export LD_LIBRARY_PATH=$(pwd)/pkg/apis/v1alpha1/providers/target/rust/target/release
          go build -o symphony-api

      - name: Run symphony-api
        working-directory: symphony/api
        run: |
          export SYMPHONY_API_URL="http://localhost:8082/v1alpha2/"
          export USE_SERVICE_ACCOUNT_TOKENS="false"
          ./symphony-api -c ./symphony-api-no-k8s.json -l Debug
