on:
  workflow_dispatch:

jobs:
  install_symphony:
    name: Symphony Install via SSH
    runs-on: ubuntu-latest

    steps:
      - name: Symphony installation
        shell: bash
        run: |
          # Install dependencies
          sudo apt update -y
          sudo apt install -y golang-go git curl build-essential

          # Install Rust (non-interactive)
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source $HOME/.cargo/env

          # Clone Symphony repository
          git clone https://github.com/eclipse-symphony/symphony.git

          # Build native Rust library
          cd symphony/api/pkg/apis/v1alpha1/providers/target/rust
          cargo build --release

          # Set library path so Go can link against Rust lib
          export LD_LIBRARY_PATH=$(pwd)/target/release:$LD_LIBRARY_PATH

          # Build symphony-api Go binary
          cd ../../../..  # back to symphony/api
          go build -o symphony-api

          # Create basic configuration if it doesn't exist
          if [ ! -f symphony-api-no-k8s.json ]; then
            cat > symphony-api-no-k8s.json <<EOF
{
  "port": "8082",
  "logLevel": "Debug",
  "providers": []
}
EOF
          fi
./symphony-api --config symphony-api-no-k8s.json
